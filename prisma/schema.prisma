// CruLink: Forge - Multi-tenant SaaS Schema
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================
// TENANT / ORGANIZATION
// =====================

model Tenant {
  id              String       @id @default(cuid())
  name            String
  slug            String       @unique // URL-safe identifier (browningwelding)
  subdomain       String?      @unique // Custom subdomain
  customDomain    String?      @unique // Full custom domain

  // Branding
  logoUrl         String?
  primaryColor    String       @default("#E63329")
  secondaryColor  String       @default("#1a1a1a")
  accentColor     String?

  // Contact
  email           String
  phone           String?
  address         Json?        // { street, city, state, zip, country }

  // Business Settings
  taxRate         Float        @default(0)
  taxLabel        String?      @default("Sales Tax")
  currency        String       @default("USD")
  timezone        String       @default("America/Chicago")

  // Subscription
  plan            TenantPlan   @default(TRIAL)
  trialEndsAt     DateTime?
  subscriptionId  String?      // Stripe subscription ID

  // Status
  status          TenantStatus @default(ACTIVE)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  users           User[]
  materials       Material[]
  services        Service[]
  finishes        Finish[]
  templates       Template[]
  quotes          Quote[]
  orders          Order[]
  customers       Customer[]
  volumeDiscounts VolumeDiscount[]
  shippingOptions ShippingOption[]

  @@index([slug])
  @@index([subdomain])
  @@index([customDomain])
}

enum TenantPlan {
  TRIAL
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
}

// =====================
// USERS & AUTH
// =====================

model User {
  id            String    @id @default(cuid())
  email         String
  name          String?
  passwordHash  String?
  emailVerified DateTime?
  image         String?

  role          UserRole  @default(STAFF)

  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  sessions      Session[]
  accounts      Account[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([email, tenantId])
  @@index([tenantId])
}

enum UserRole {
  OWNER
  ADMIN
  STAFF
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// =====================
// CUSTOMERS (Quote Recipients)
// =====================

model Customer {
  id          String   @id @default(cuid())
  email       String
  name        String?
  phone       String?
  company     String?
  address     Json?

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  quotes      Quote[]
  orders      Order[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([email, tenantId])
  @@index([tenantId])
}

// =====================
// CATALOG: MATERIALS
// =====================

model Material {
  id            String   @id @default(cuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  category      String   // carbon-steel, stainless, aluminum
  categoryName  String   // Carbon Steel, Stainless Steel, Aluminum
  categoryIcon  String?
  categoryImage String?
  categoryDesc  String?

  subcategory     String   // mild-steel, 304-stainless, etc.
  subcategoryName String
  subcategoryDesc String?

  // Pricing per thickness (JSON array)
  thicknesses   Json     // [{ gauge, inches, mm, pricePerSqIn }]

  isActive      Boolean  @default(true)
  sortOrder     Int      @default(0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  quoteItems    QuoteItem[]

  @@index([tenantId])
  @@index([category])
}

// =====================
// CATALOG: SERVICES
// =====================

model Service {
  id            String   @id @default(cuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name          String
  description   String?
  category      String   // cutting, forming, machining, assembly, finishing
  icon          String?

  // Pricing
  basePrice     Float    @default(0)
  pricePerUnit  Float?   // Per inch, per hole, per bend, etc.
  unitType      String?  // "inch", "hole", "bend", "spot", "sqin"

  // Configuration (JSON for flexibility)
  config        Json?    // Service-specific options (weld types, hardware options, etc.)

  included      Boolean  @default(false) // Included in base price
  requiresSelection Boolean @default(false)
  isActive      Boolean  @default(true)
  sortOrder     Int      @default(0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  quoteItemServices QuoteItemService[]

  @@index([tenantId])
  @@index([category])
}

// =====================
// CATALOG: FINISHES
// =====================

model Finish {
  id                  String   @id @default(cuid())
  tenantId            String
  tenant              Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name                String
  description         String?

  priceMultiplier     Float    @default(1.0)
  leadTimeDays        Int      @default(0)
  minOrderQty         Int?
  note                String?

  compatibleMaterials String[] // ["carbon-steel", "aluminum", "all"]
  colors              Json?    // [{ id, name, hex, upcharge }]
  options             Json?    // Additional options

  isActive            Boolean  @default(true)
  sortOrder           Int      @default(0)

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  quoteItems          QuoteItem[]

  @@index([tenantId])
}

// =====================
// TEMPLATES
// =====================

model Template {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String
  description String?
  category    String   // basic, brackets, plates, enclosures, hardware
  icon        String?

  // MakerJS/3D shape definition
  shapeType   String   // rectangle, circle, triangle, mounting-plate, etc.
  parameters  Json     // Array of parameter definitions

  popular     Boolean  @default(false)
  bendRequired Boolean @default(false)

  isActive    Boolean  @default(true)
  isGlobal    Boolean  @default(false) // Available to all tenants
  isCustom    Boolean  @default(false) // Custom template created by tenant
  sortOrder   Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  quoteItems  QuoteItem[]

  @@index([tenantId])
  @@index([category])
}

// =====================
// VOLUME DISCOUNTS
// =====================

model VolumeDiscount {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  minQty    Int
  maxQty    Int?     // null = unlimited
  discount  Float    // Percentage discount (0.05 = 5%)

  @@index([tenantId])
}

// =====================
// SHIPPING
// =====================

model ShippingOption {
  id          String       @id @default(cuid())
  tenantId    String
  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String
  description String?

  type        ShippingType
  price       Float?       // Fixed price (null = calculated)

  estimatedDays String?    // "3-5 business days"

  isActive    Boolean      @default(true)
  sortOrder   Int          @default(0)

  @@index([tenantId])
}

enum ShippingType {
  PICKUP
  FLAT_RATE
  CALCULATED
}

// =====================
// QUOTES
// =====================

model Quote {
  id          String      @id @default(cuid())
  number      String      // QUO-2024-0001

  tenantId    String
  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  customerId  String?
  customer    Customer?   @relation(fields: [customerId], references: [id])

  // Customer info (denormalized for guest quotes)
  customerEmail String
  customerName  String?
  customerPhone String?
  customerCompany String?

  status      QuoteStatus @default(DRAFT)

  // Line items
  items       QuoteItem[]

  // Totals
  subtotal    Float
  taxAmount   Float
  shippingAmount Float?
  discountAmount Float?
  total       Float

  // Validity
  expiresAt   DateTime?

  // Notes
  customerNotes String?
  internalNotes String?

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  convertedAt DateTime?   // When converted to order

  order       Order?

  @@unique([number, tenantId])
  @@index([tenantId])
  @@index([customerId])
  @@index([status])
}

enum QuoteStatus {
  DRAFT
  SENT
  VIEWED
  ACCEPTED
  EXPIRED
  REJECTED
}

model QuoteItem {
  id          String    @id @default(cuid())
  quoteId     String
  quote       Quote     @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  // Template/Shape
  templateId  String?
  template    Template? @relation(fields: [templateId], references: [id])

  // Custom upload (alternative to template)
  uploadedFileUrl  String?
  uploadedFileName String?

  // Dimensions & Parameters
  parameters  Json      // { width: 6, height: 4, cornerRadius: 0.25 }
  dimensions  Json      // { width, height, area, perimeter }

  // Material
  materialId  String
  material    Material  @relation(fields: [materialId], references: [id])
  thickness   Json      // { gauge, inches, mm, pricePerSqIn }

  // Finish
  finishId    String?
  finish      Finish?   @relation(fields: [finishId], references: [id])
  finishColor String?
  finishOption String?

  // Services
  services    QuoteItemService[]

  // Pricing
  quantity    Int
  unitPrice   Float
  lineTotal   Float

  // Generated files
  dxfFileUrl    String?
  specSheetUrl  String?

  sortOrder   Int       @default(0)

  @@index([quoteId])
}

model QuoteItemService {
  id           String    @id @default(cuid())
  quoteItemId  String
  quoteItem    QuoteItem @relation(fields: [quoteItemId], references: [id], onDelete: Cascade)

  serviceId    String
  service      Service   @relation(fields: [serviceId], references: [id])

  // Service-specific options
  options      Json?     // { weldType: "mig", weldLength: 12 }

  price        Float

  @@index([quoteItemId])
}

// =====================
// ORDERS
// =====================

model Order {
  id          String        @id @default(cuid())
  number      String        // ORD-2024-0001

  tenantId    String
  tenant      Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  quoteId     String?       @unique
  quote       Quote?        @relation(fields: [quoteId], references: [id])

  customerId  String?
  customer    Customer?     @relation(fields: [customerId], references: [id])

  status      OrderStatus   @default(PENDING)

  // Shipping
  shippingMethod  String?
  shippingAddress Json?
  trackingNumber  String?
  carrier         String?

  // Payment
  paymentStatus   PaymentStatus @default(PENDING)
  paymentIntentId String?       // Stripe
  paidAt          DateTime?

  // Totals
  subtotal        Float
  taxAmount       Float
  shippingAmount  Float?
  total           Float

  // Notes
  customerNotes   String?
  internalNotes   String?

  // Timeline
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  confirmedAt     DateTime?
  startedAt       DateTime?     // Production started
  completedAt     DateTime?
  shippedAt       DateTime?
  deliveredAt     DateTime?

  // History
  statusHistory   OrderStatusHistory[]
  messages        OrderMessage[]

  @@unique([number, tenantId])
  @@index([tenantId])
  @@index([customerId])
  @@index([status])
}

enum OrderStatus {
  PENDING
  CONFIRMED
  IN_PRODUCTION
  QUALITY_CHECK
  READY_TO_SHIP
  SHIPPED
  DELIVERED
  CANCELLED
  ON_HOLD
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  PAID
  PARTIALLY_REFUNDED
  REFUNDED
  FAILED
}

model OrderStatusHistory {
  id        String       @id @default(cuid())
  orderId   String
  order     Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)

  fromStatus OrderStatus?
  toStatus   OrderStatus
  note       String?
  changedBy  String?      // User ID

  createdAt DateTime     @default(now())

  @@index([orderId])
}

model OrderMessage {
  id        String        @id @default(cuid())
  orderId   String
  order     Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  fromType  MessageSender
  fromId    String?       // User ID or Customer ID
  fromName  String

  content   String        @db.Text

  isRead    Boolean       @default(false)
  readAt    DateTime?

  createdAt DateTime      @default(now())

  @@index([orderId])
}

enum MessageSender {
  CUSTOMER
  STAFF
  SYSTEM
}
